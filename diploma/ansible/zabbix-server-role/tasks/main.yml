---
# tasks file for zabbix-server

- name: Download and install zabbix repository from official .deb package
  apt:
    deb: https://repo.zabbix.com/zabbix/6.0/debian/pool/main/z/zabbix-release/zabbix-release_6.0-4+debian11_all.deb

- name: Update repositories cache and install packages required by zabbix documentation and community.postgresql.postgresql modules
  apt:
    pkg:
    - postgresql
    - zabbix-server-pgsql
    - zabbix-frontend-php
    - php7.4-pgsql
    - zabbix-apache-conf
    - zabbix-sql-scripts
    - zabbix-agent
    - acl #required to avoid "Failed to set permissions on the temporary files Ansible needs to create when becoming an unprivileged user" error
    - python3-psycopg2 #required to avoid "Failed to import the required Python library (psycopg2) on zabbix-server's Python /usr/bin/python3" error
    update_cache: yes
    state: present

- name: Start zabbix-server apache2 postgresql and make them enabled on boot
  service:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - zabbix-server
    - postgresql
    - apache2 

- name: Create user zabbix in postgresql
  become_user: postgres
  community.postgresql.postgresql_user:
    name: zabbix
    password: "supersecretpassword"

- name: Create database zabbix owned by user zabbix
  become_user: postgres
  community.postgresql.postgresql_db:
    name: zabbix
    owner: zabbix

- name: Check if zabbix database already has data-schema
  shell: sudo -u postgres psql -d zabbix -c "\dt" 2>&1
  register: dt_result

- name: Import initial data-schema
  shell:
    cmd: zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | sudo -u zabbix psql zabbix
  when: "'Did not find any relations' in dt_result.stdout"

- name: Update zabbix_server.conf with DBPassword=
  replace:
    path: /etc/zabbix/zabbix_server.conf
    regexp: '^# DBPassword=$'
    replace: 'DBPassword=supersecretpassword'
  notify: 
    - Restart zabbix-server apache2 postgresql handler

- name: Copy zabbix.conf.php to /etc/zabbix/web/
  copy: 
    src: "zabbix.conf.php"
    dest: "/etc/zabbix/web"
    mode: '0600'
    owner: www-data
    group: www-data
  notify: 
    - Restart zabbix-server apache2 postgresql handler