---
# tasks file for nginx-role

- name: Install nginx
  apt:
    name: nginx
    state: present

- name: Create the directory for index.html file.
  file:
    path: "{{ destin_folder_nginx }}"
    state: directory

- name: Create "static" directory 
  file:
    path: "{{ destin_folder_nginx }}/static"
    state: directory

- name: Copy files to "static" directory
  copy: 
    src: "{{ item }}"
    dest: "{{ destin_folder_nginx }}/static"
    mode: 0555
  loop:
    - "./static/css"
    - "./static/js"
  notify: 
    - Restart Nginx handler

- name: Copy files to root directory nginx
  copy: 
    src: "{{ item }}"
    dest: "{{ destin_folder_nginx }}"
    mode: 0555
  loop:
    - "asset-manifest.json"
    - "index.html" 
  notify: 
    - Restart Nginx handler

#- name: Make index.html
#  template:
#    src: "index.html.j2"
#    dest: "{{ destin_folder_nginx }}/index.html"
#    mode: 0555
#  notify:
#    - Restart Nginx handler 

- name: Make nginx.conf
  template:
    src: "nginx.conf.j2"
    dest: "/etc/nginx/nginx.conf"
    mode: 0555
  notify:
    - Restart Nginx handler

- name: Copy ssl certificate files for nginx
  copy: 
    src: "{{ item }}"
    dest: "/etc/nginx"
    mode: 0555
  loop:
    - "cert.pem"
    - "cert.key" 
  notify: 
    - Restart Nginx handler

- name: Start "nginx" and make it enabled on boot
  service:
    name: nginx
    state: started
    enabled: yes

- name: Website availability check. 
  uri:
    url: "http://{{ ansible_default_ipv4.address }}"
    return_content: yes
  register: out

- name: Print uri's out
  debug:
    msg: "{{ out.status }}" 
