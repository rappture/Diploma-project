---
# tasks file for zabbix-agent

- name: Download and install zabbix repository from official .deb package
  apt:
    deb: https://repo.zabbix.com/zabbix/6.0/debian/pool/main/z/zabbix-release/zabbix-release_6.0-4+debian11_all.deb

- name: Update repositories cache and install packages required by zabbix documentation
  apt:
    pkg:
    - postgresql
    - zabbix-server-pgsql
    - zabbix-frontend-php
    - php7.4-pgsql
    - zabbix-apache-conf
    - zabbix-sql-scripts
    - zabbix-agent
#    - acl #только если заработают встроенные модули постгреса
#    - python3-psycopg2 #только если заработают встроенные модули постгреса
    update_cache: yes
    state: present

- name: Start zabbix-server apache2 postgresql and make them enabled on boot
  service:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - zabbix-server
    - postgresql
    - apache2 

#- name: Create user zabbix in postgresql
##  become: yes
#  become_user: postgres
#  community.postgresql.postgresql_user:
#    name: zabbix
#    password: "supersecretpassword"

#- name: Create database zabbix owned by user zabbix
##  become: yes
#  become_user: postgres
#  community.postgresql.postgresql_db:
#    name: zabbix
#    owner: zabbix

- name: Create user zabbix in postgresql
  shell:
    cmd: su - postgres -c 'psql --command "CREATE USER zabbix WITH PASSWORD '\'supersecretpassword\'';"'

- name: Create database zabbix owned by user zabbix 
  shell:
    cmd: su - postgres -c 'psql --command "CREATE DATABASE zabbix OWNER zabbix;"'

- name: Import initial data-schema
  shell:
    cmd: zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | sudo -u zabbix psql zabbix

- name: Uddate zabbix_server.conf with DBPassword=
  replace:
    path: /etc/zabbix/zabbix_server.conf
    regexp: '^# DBPassword=$'
    replace: 'DBPassword=supersecretpassword'
  notify: 
    - Restart zabbix-server apache2 postgresql handler

- name: Copy zabbix.conf.php to /etc/zabbix/web/
  copy: 
    src: "zabbix.conf.php"
    dest: "/etc/zabbix/web"
    mode: '0600'
    owner: www-data
    group: www-data
  notify: 
    - Restart zabbix-server apache2 postgresql handler

#sudo -u postgres psql -U postgres

#SELECT datname, pg_get_userbyid(datdba) as owner
#FROM pg_database;